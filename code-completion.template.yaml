apiVersion: v1
kind: ConfigMap
metadata:
  name: code-completion
  namespace: costrict
data:
  config.yaml: |
    context:
      definition:
        disabled: true
        url: "http://codebase-querier-svc.costrict.svc.cluster.local:8888/codebase-indexer/api/v1/search/definition"
      semantic:
        disabled: true
        url: "http://codebase-querier-svc.costrict.svc.cluster.local:8888/codebase-embedder/api/v1/search/semantic"
        topK: 5
        scoreThreshold: 0.5
      relation:
        disabled: true
        url: "http://codebase-querier-svc.costrict.svc.cluster.local:8888/codebase-indexer/api/v1/search/relation"
        layer: 3
        includeContent: false
      requestTimeout: 400ms
      totalTimeout: 500ms
    models:
      - completionsUrl: "${{__env_profile.completions_url}}"
        provider: deepseek
        modelTitle: "default"
        modelName: "${{__env_profile.model_name}}"
        authorization: "${{__env_profile.model_authorization}}"
        tags:
          - fastertransformer
          - deepseek
        timeout: 1000ms
        maxPrefix: 512
        maxSuffix: 50
        maxOutput: 50
        fimBegin: "<｜fim▁begin｜>"
        fimEnd: "<｜fim▁end｜>"
        fimHole: "<｜fim▁hole｜>"
        fimStop: ["<｜end▁of▁sentence｜>", "<|EOT|>", "▁<MID>"]
        tokenizerPath: "bin/deepseek-tokenizer/tokenizer.json"
        maxConcurrent: ${{__env_profile.model_concurrent}}
        disablePrune: true
        customPruners: []
    streamController:
      maintainInterval: 600s
      completionTimeout: 2000ms
      queueTimeout: 200ms
      cleanOlderThan: 24h
    wrapper:
      score:
        disabled: true
        threshold: 0.3
      syntax:
        disabled: false
        threshold: 0.5
        strPattern: ".*"
        treePattern: ".*"
        minPromptLine: 5
        endTag: "</completion>"
      prune:
        disabled: false
        pruners: []

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: code-completion
  namespace: costrict
  labels:
    app.kubernetes.io/name: code-completion
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: code-completion
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: code-completion
        app.kubernetes.io/name: code-completion
    spec:
      containers:
      - image: ${{SHENMA_DOCKER_REPO}}/code-completion:${{IMAGE_TIMESTAMP}}
        imagePullPolicy: IfNotPresent
        name: code-completion
        ports:
        - containerPort: 8080
          protocol: TCP
        resources:
          limits:
            cpu: 2
            memory: 2Gi
          requests:
            cpu: 1
            memory: 1Gi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
          - mountPath: /app/config.yaml
            name: config-volume
            subPath: config.yaml
      volumes:
        - configMap:
            defaultMode: 420
            name: code-completion
          name: config-volume
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  namespace: costrict
  name: code-completion
  labels:
    app: code-completion
    app.kubernetes.io/name: code-completion
spec:
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  selector:
    app: code-completion
